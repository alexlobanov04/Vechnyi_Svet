/**
 * common.js - Общая логика для приложения "Вечный Свет"
 */

const BIBLE_BOOKS = {
    "быт": 1, "бытие": 1,
    "исх": 2, "исход": 2,
    "лев": 3, "левит": 3,
    "чис": 4, "числа": 4,
    "вт": 5, "втор": 5, "второзаконие": 5,
    "иис": 6, "нав": 6, "иисуснавин": 6,
    "суд": 7, "судьи": 7,
    "руф": 8, "руфь": 8,
    "1цар": 9, "1-яцарств": 9,
    "2цар": 10, "2-яцарств": 10,
    "3цар": 11, "3-яцарств": 11,
    "4цар": 12, "4-яцарств": 12,
    "1пар": 13, "1-япаралипоменон": 13,
    "2пар": 14, "2-япаралипоменон": 14,
    "ездр": 15, "ездра": 15,
    "неем": 16, "неемия": 16,
    "есф": 17, "есфирь": 17,
    "иов": 18,
    "пс": 19, "псалтирь": 19, "псалом": 19,
    "пр": 20, "притч": 20, "притчи": 20,
    "еккл": 21, "экклезиаст": 21,
    "песн": 22, "песнь": 22,
    "ис": 23, "исаия": 23,
    "иер": 24, "иеремия": 24,
    "плач": 25,
    "иез": 26, "иезекииль": 26,
    "дан": 27, "даниил": 27,
    "ос": 28, "осия": 28,
    "иоиль": 29,
    "ам": 30, "амос": 30,
    "авд": 31, "авдий": 31,
    "иона": 32,
    "мих": 33, "михея": 33,
    "наум": 34,
    "авв": 35, "аввакум": 35,
    "соф": 36, "софония": 36,
    "агг": 37, "аггей": 37,
    "зах": 38, "захария": 38,
    "мал": 39, "малахия": 39,
    "мф": 40, "мт": 40, "матфея": 40, "матфей": 40,
    "мк": 41, "марка": 41, "марк": 41,
    "лк": 42, "луки": 42, "лук": 42,
    "ин": 43, "иоанна": 43, "иоанн": 43,
    "деян": 44, "деяния": 44,
    "иак": 45, "иакова": 45,
    "1пет": 46, "1-епетра": 46,
    "2пет": 47, "2-епетра": 47,
    "1ин": 48, "1-еиоанна": 48,
    "2ин": 49, "2-еиоанна": 49,
    "3ин": 50, "3-еиоанна": 50,
    "иуд": 51, "иуды": 51,
    "рим": 52, "римлянам": 52,
    "1кор": 53, "1-екоринфянам": 53,
    "2кор": 54, "2-екоринфянам": 54,
    "гал": 55, "галатам": 55,
    "еф": 56, "ефесянам": 56,
    "флп": 57, "филиппийцам": 57,
    "кол": 58, "колоссянам": 58,
    "1фес": 59, "1-ефессалоникийцам": 59,
    "2фес": 60, "2-ефессалоникийцам": 60,
    "1тим": 61, "1-етимофею": 61,
    "2тим": 62, "2-етимофею": 62,
    "тит": 63, "титу": 63,
    "флм": 64, "филимону": 64,
    "евр": 65, "евреям": 65,
    "откр": 66, "откровение": 66
};

window.BIBLE_BOOKS = BIBLE_BOOKS;

// Канал для связи между окнами
const channel = new BroadcastChannel('bible_display');

/**
 * Парсит строку запроса вида "ин 3 16" или "1 кор 13:4-8"
 */
function parseQuery(query) {
    query = query.toLowerCase().replace(/[:]/g, ' ').replace(/\s+/g, ' ').trim();

    // Регулярка для сложных названий типа "1 кор" или просто "ин"
    const match = query.match(/^(\d?\s?[а-яё]+)\s+(\d+)\s*([\d\-\,]*)$/);

    if (!match) return null;

    let bookName = match[1].replace(/\s/g, '');
    let chapter = match[2];
    let verse = match[3] || "1";

    let bookId = BIBLE_BOOKS[bookName];

    // Если не нашли в русском списке, ищем в казахском (если загружен)
    if (!bookId && typeof KTB_BOOK_MAP !== 'undefined') {
        bookId = KTB_BOOK_MAP[bookName];
    }

    if (!bookId) return null;

    return {
        bookId,
        bookName: bookName, // Для отображения
        chapter,
        verse
    };
}

async function fetchVerse(parsed, translation = 'RST') {
    // В зависимости от перевода выбираем базу данных
    let db = null;
    if (translation === 'RST') {
        if (typeof BIBLE_DATA !== 'undefined') db = BIBLE_DATA;
    } else if (translation === 'NRT') {
        if (typeof NRT_DATA !== 'undefined') db = NRT_DATA;
    } else if (translation === 'KTB') {
        if (typeof KTB_DATA !== 'undefined') db = KTB_DATA;
    }

    if (!db) {
        console.error(`База данных для ${translation} не загружена.`);
        return null;
    }

    try {
        const book = db.Books.find(b => b.BookId === parsed.bookId);
        if (!book) return null;

        const chapter = book.Chapters.find(c => c.ChapterId === parseInt(parsed.chapter));
        if (!chapter) return null;

        // Обработка диапазона стихов (например, "1-5" или "1,3")
        let versesText = [];
        let versesList = [];

        // Если указан диапазон (например, 1-3)
        if (parsed.verse.includes('-')) {
            const [start, end] = parsed.verse.split('-').map(Number);
            versesList = chapter.Verses.filter(v => v.VerseId >= start && v.VerseId <= end);
        }
        // Если указаны конкретные стихи через запятую (на будущее, пока парсер это не ловит, но на всякий случай)
        else if (parsed.verse.includes(',')) {
            const ids = parsed.verse.split(',').map(Number);
            versesList = chapter.Verses.filter(v => ids.includes(v.VerseId));
        }
        // Один стих
        else {
            const vId = parseInt(parsed.verse);
            const v = chapter.Verses.find(v => v.VerseId === vId);
            if (v) versesList = [v];
        }

        if (versesList.length > 0) {
            // Собираем текст
            const text = versesList.map(v => v.Text).join(' ');

            // Получаем официальное название книги из базы (опционально, или из нашего словаря)
            // Но в BIBLE_DATA названия книг не хранятся явно в корне массива Books, там только ID?
            // Проверим... В превью JSON названия книги не было внутри объекта Book. 
            // Значит берем из нашего словаря или parsed.bookName.
            // Лучше использовать "красивое" имя. Допишем карту имен.

            // Формируем красивую ссылку
            let refVertex = parsed.verse; // 1-5 или 1
            let bookNameTitle = getBookTitle(parsed.bookId);
            if (book.BookName) {
                bookNameTitle = book.BookName;
            }

            return {
                text: text,
                reference: `${bookNameTitle} ${parsed.chapter}:${refVertex}`,
                bookName: bookNameTitle,
                chapter: parsed.chapter,
                verse: parsed.verse,
                bookId: parsed.bookId // Важно для переключения переводов
            };
        }

    } catch (e) {
        console.error("Ошибка при локальном поиске:", e);
    }
    return null;
}

// Вспомогательная функция для имен книг (так как в JSON мы видели только ID)
function getBookTitle(id) {
    const titles = {
        1: "Бытие", 2: "Исход", 3: "Левит", 4: "Числа", 5: "Второзаконие",
        6: "Иисус Навин", 7: "Судьи", 8: "Руфь", 9: "1-я Царств", 10: "2-я Царств",
        11: "3-я Царств", 12: "4-я Царств", 13: "1-я Паралипоменон", 14: "2-я Паралипоменон",
        15: "Ездра", 16: "Неемия", 17: "Есфирь", 18: "Иов", 19: "Псалтирь", 20: "Притчи",
        21: "Екклесиаст", 22: "Песнь Песней", 23: "Исаия", 24: "Иеремия", 25: "Плач Иеремии",
        26: "Иезекииль", 27: "Даниил", 28: "Осия", 29: "Иоиль", 30: "Амос", 31: "Авдий",
        32: "Иона", 33: "Михей", 34: "Наум", 35: "Аввакум", 36: "Софония", 37: "Аггей",
        38: "Захария", 39: "Малахия", 40: "От Матфея", 41: "От Марка", 42: "От Луки",
        43: "От Иоанна", 44: "Деяния", 45: "Иакова", 46: "1-е Петра", 47: "2-е Петра",
        48: "1-е Иоанна", 49: "2-е Иоанна", 50: "3-е Иоанна", 51: "Иуды", 52: "Римлянам",
        53: "1-е Коринфянам", 54: "2-е Коринфянам", 55: "Галатам", 56: "Ефесянам",
        57: "Филиппийцам", 58: "Колоссянам", 59: "1-е Фессалоникийцам", 60: "2-е Фессалоникийцам",
        61: "1-е Тимофею", 62: "2-е Тимофею", 63: "Титу", 64: "Филимону", 65: "Евреям", 66: "Откровение"
    };
    return titles[id] || "Библия";
}
